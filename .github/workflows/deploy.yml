name: Deploy to Azure Container Apps

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'client/**'
      - 'package.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  BACKEND_IMAGE_NAME: shifts-dashboard-backend
  FRONTEND_IMAGE_NAME: shifts-dashboard-frontend

jobs:
  check-infrastructure:
    name: Check Infrastructure
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.check.outputs.registry }}
      backendApp: ${{ steps.check.outputs.backendApp }}
      frontendApp: ${{ steps.check.outputs.frontendApp }}
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check Resources
        id: check
        run: |
          environment="${{ github.event.inputs.environment || 'dev' }}"
          rg="${{ secrets.AZURE_RESOURCE_GROUP }}"

          echo "Checking for required Azure resources in $rg..."

          # Find Container Registry
          registry=$(az acr list --resource-group $rg --query "[0].loginServer" -o tsv)
          if [ -z "$registry" ]; then
            echo "ERROR: No Container Registry found. Run infrastructure deployment first."
            exit 1
          fi

          # Find Backend Container App
          backendApp=$(az containerapp list --resource-group $rg --query "[?contains(name, 'backend')].name | [0]" -o tsv)
          if [ -z "$backendApp" ]; then
            echo "ERROR: No backend Container App found. Run infrastructure deployment first."
            exit 1
          fi

          # Find Frontend Container App
          frontendApp=$(az containerapp list --resource-group $rg --query "[?contains(name, 'frontend')].name | [0]" -o tsv)
          if [ -z "$frontendApp" ]; then
            echo "ERROR: No frontend Container App found. Run infrastructure deployment first."
            exit 1
          fi

          echo "All required resources found"
          echo "registry=$registry" >> $GITHUB_OUTPUT
          echo "backendApp=$backendApp" >> $GITHUB_OUTPUT
          echo "frontendApp=$frontendApp" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: check-infrastructure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get ACR Credentials
        id: acr-creds
        run: |
          registryName=$(echo ${{ needs.check-infrastructure.outputs.registry }} | cut -d'.' -f1)
          username=$(az acr credential show --name $registryName --query username -o tsv)
          password=$(az acr credential show --name $registryName --query "passwords[0].value" -o tsv)
          echo "::add-mask::$password"
          echo "username=$username" >> $GITHUB_OUTPUT
          echo "password=$password" >> $GITHUB_OUTPUT

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ needs.check-infrastructure.outputs.registry }}
          username: ${{ steps.acr-creds.outputs.username }}
          password: ${{ steps.acr-creds.outputs.password }}

      - name: Build and push backend image
        run: |
          docker build -f backend/Dockerfile \
            -t ${{ needs.check-infrastructure.outputs.registry }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ needs.check-infrastructure.outputs.registry }}/${{ env.BACKEND_IMAGE_NAME }}:latest \
            .
          docker push ${{ needs.check-infrastructure.outputs.registry }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ needs.check-infrastructure.outputs.registry }}/${{ env.BACKEND_IMAGE_NAME }}:latest

      - name: Build and push frontend image
        run: |
          docker build -f client/Dockerfile \
            -t ${{ needs.check-infrastructure.outputs.registry }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ needs.check-infrastructure.outputs.registry }}/${{ env.FRONTEND_IMAGE_NAME }}:latest \
            .
          docker push ${{ needs.check-infrastructure.outputs.registry }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ needs.check-infrastructure.outputs.registry }}/${{ env.FRONTEND_IMAGE_NAME }}:latest

  deploy:
    name: Deploy to Container Apps
    runs-on: ubuntu-latest
    needs: [check-infrastructure, build-and-push]
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend
        run: |
          az containerapp update \
            --name ${{ needs.check-infrastructure.outputs.backendApp }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ needs.check-infrastructure.outputs.registry }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}

          echo "Backend deployed"

      - name: Deploy Frontend
        run: |
          az containerapp update \
            --name ${{ needs.check-infrastructure.outputs.frontendApp }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ needs.check-infrastructure.outputs.registry }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}

          echo "Frontend deployed"

      - name: Get URLs
        id: urls
        run: |
          backendUrl=$(az containerapp show \
            --name ${{ needs.check-infrastructure.outputs.backendApp }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          frontendUrl=$(az containerapp show \
            --name ${{ needs.check-infrastructure.outputs.frontendApp }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)

          echo "backendUrl=https://$backendUrl" >> $GITHUB_OUTPUT
          echo "frontendUrl=https://$frontendUrl" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment successful**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Application URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ steps.urls.outputs.backendUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.urls.outputs.frontendUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Images**: \`latest\`, \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Logout from Azure
        if: always()
        run: az logout
